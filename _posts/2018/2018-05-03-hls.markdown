---
layout: "post"
title: "HLS"
date: "2018-05-03 15:32"
---

# 一、简介

本文档介绍了通过HTTP传输极大的多媒体数据流的协议[RFC2616]。该协议支持媒体数据的加密，并提供流的备用版本（如比特率）。媒体数据可以在创建后被很快地传输，允许它在近实时被接收。

在第11章中列出了，如HTTP的，描述相关标准的外部引用。

# 二、概述

多媒体演示文稿是由播放列表文件中的URL指定的，播放列表是一个由URL和信息标签组成的有序列表。每一个URL都关联了一个媒体文件，该媒体文件是一个连续数据流的一个分片。

为了播放数据流，客户端首先获取播放列表文件，然后获取并播放列表中的每一个媒体文件。正如本文档所描述的那样，它通过重载播放列表文件来发现其他新增的分片。

文档中的关键词“必须”“不准”，“需要”“应该”“不应该”“推荐”“可以”“可选”等见RFC2119。

# 三、播放列表文件

## 3.1介绍

播放列表必须是扩展的**M3U**文件，该文档通过定义新的标签扩展了m3u文件的格式。M3U播放列表是一个文本文件，它包含了各自独立的行，行以一个LF字符或者LF字符紧跟一个CR字符来结束。行可以是一个URL，空行，或者以字符#开头。空行将会被忽略。空格只能作为一行中不同元素间的分隔。

一个URL 表示一个媒体文件或是变种播放列表文件（见3.2.7）

URL可以是相对的，一个相对的URL必须被包含该URL的播放列表文件中的URL所解析。

**以注释字符#开头的行可能是注释或者标签，标签以#EXT开头**，其他所有行都应该被忽略。播放列表文件的持续时间是他所指向的媒体文件的时长的总和。

以.M3U8作为文件名后缀或者HTTPContent-Type（RFC2616）为“`Application/ vnd.apple.mpegurl`”的M3U播放列表文件使用UTF-8（RFC3629）编码。以.M3U作为文件名后缀或者HTTPContent-Type为“`audio/mpegurl`”的M3U播放列表文件使用US-ASCII编码。

播放列表文件名必须以.M3U8为后缀、HTTPContent-Type为“Application/vnd.apple.mpegurl”（如果使用http传输）或者以.M3U为后缀、HTTPContent-Type为“audio/mpegurl”。

**扩展的M3U文件格式定义了两种标签：EXTM3U和EXTINF。区分扩展的M3U文件与普通M3U文件的关键在于前者的首行为#EXTM3U。**

EXTINF是一个记录标记，该标记描述了后边URL所指定的媒体文件。每个媒体文件URL前边必须有EXTINF标签。格式如下：

```
\#EXTINF: <DURATION>, <TITLE>
```

DURATION是一个整数，它指定了媒体文件以秒为单位的持续时间，**时间应四舍五入到最接近的整数**。行内逗号后边的剩余部分是媒体文件的名字，该名字是媒体分片的人眼可读的信息标题。

该文档定义了如下的新标签：

EXT-X-TARGETDURATION，EXT-X-MEDIA-SEQUENCE，EXT-X-KEY，EXT-X-PROGRAM-DATE-TIME，EXT-X-ALLOW-CATCH，EXT-X-ENDLIST，EXT-X-STREAM-INF，EXT-X-DISCONTINUITY，EXT-X-VERSION

## 3.2 新标签

### 3.2.1、EXT-X-TARGETDURATION

该标签指定了媒体文件持续时间的最大值，播放文件列表中的媒体文件在EXTINF标签中定义的持续时间必须小于或者等于该标签指定的持续时间。该标签在播放列表文件中必须出现一次，其格式为：

```
# EXT-X-TARGETDURATION：<s>
```

<pre>
S是一个以秒为单位的整数。
</pre>

### 3.2.2、EXT-X-MEDIA-SEQUENCE

播放列表文件中每个媒体文件的URL都有一个唯一的序列号。URL的序列号等于它之前那个RUI的序列号加一。EXT-X-MEDIA-SEQUENCE指明了出现在播放列表文件中的第一个URL的序列号（可选）。其格式如下：

<pre>
#EXT-X-MEDIA-SEQUENCE：< Number >
</pre>

<u>播放列表文件中的EXT-X-MEDIA-SEQUENCE标签不能多于一个</u>。如果播放列表文件中没有EXT-X-MEDIA-SEQUENCE标签，那么将会把播放列表中第一个URL的序列号当成0。

> 媒体文件的序列号码**不是必须出现**在它的URL中的。见6.3.2和6.3.5。

### 3.2.3、EXT-X-KEY

**媒体文件可能是被加密的，EXT-X-KEY提供了解密媒体文件的必要信息**，它的格式如下：

<pre>
#EXT-X-KEY：METHOD=<method> [,URL = “<URL>”] [,IV = <iv>]
</pre>

Method属性指定了加密方法，定义了两种加密方法：NONE和AES-128。

加密方法NONE表示媒体文件不被加密，如果加密方法是NONE，那么URL和IV属性不允许存在。

加密方法AES-128表示媒体文件使用高级加密标准128位密钥和PKCS7 padding加密。如果加密方法是AES-128，那么对于URL属性，如果存在，则指定获取密钥的方法；对于IV属性，如果存在，则指定使用密钥的初始化向量。

IV属性出现在协议版本2中，<u>新的EXT-X-KEY将会取代任何一个先前的EXT-X-KEY</u>。

如果播放列表文件没有包含EXT-X-KEY标签，那么媒体文件将不会被加密。

密钥文件的格式见第五章，媒体文件加密信息见5.2、6.2.3、6.3.6。

### 3.2.4、EXT-X-PROGRAM-DATE-TIME

<u>EXT-X-PROGRAM-DATE-TIME标签将下一个媒体文件的开头和绝对日期关联起来</u>。日期/时间的表示基于ISO/IEC，并且要指明时区。例如：

<pre>
#EXT-X-PROGRAM-DATE-TIME: < YYYY – MM – DDT hh : mm : ssZ>
</pre>

> 详见6.2.1和6.3.3

### 3.2.5、EXT-X-ALLOW-CATCH

EXT-X-ALLOW-CATCH标签指定客户端可以或者不准缓存下载的媒体文件用来重播。<u>它可能会出现在播放列表文件的任何地方，但是不能出现两次或以上</u>。该标签适用于播放列表中的所有分片。其格式如下：

<pre>
#EXT-X-ALLOW-CACHE: <YES|NO>
</pre>

>详见6.3.3

### 3.2.6、EXT-X-ENDLIST

EXT-X-ENDLIST标签标示没有更多媒体文件将会加入到播放列表中（hls live流中不会存在此标签，除非已知直播流停止了），它可能会出现在播放列表文件的任何地方，但是不能出现两次或以上（出现在哪在哪结束）。其格式如下：

```
#EXT-X-ENDLIST
```

### 3.2.7、EXT-X-STREAM-INF

EXT-X-STREAM-INF标签**表示在播放列表中的下一个URL标识另一个播放列表文件（用来做m3u8的嵌套，比如在带宽不同时切换不同的码率）**。格式如下：

\#EXT-X-STREAM-INF: [attribute=value] [, attribute=value]* <URL>

在一个EXT-X-STREAM-INF标签中attribute不能出现两次或以上。其它属性定义：

BANDWIDTH = <n>

n为每秒比特数,它必须是每个媒体文件比特速率的上限，必须经过计算包含那些在播放列表中出现的或者将要出现的容器开销。

PROGRAM-ID= <i>

i 是一个数字，在播放列表文件的范围内唯一的标识了一个特定的演示文稿。

一个播放列表文件可能包含多个具有相同PROGRAM-ID 的EXT-X-STREAM-INF标签来标识某个演示文稿的不同编码。这些变种的的播放列表可能包含额外的EXT-X-STREAM-INF标签。

CODECS="[format][,format]*"

<u>每一种格式都指定了存在于媒体文件中的媒体类型。合法的格式标示符都是那些在ISO文件格式名称空间被RFC4281定义的格式</u>。

RESOLUTION=<N>x<M>

<u>N是流中视频水平编码分辨率的近似，以像素数表示，M是编码垂直分辨率的近似</u>。

### 3.2.8、EXT-X-DISCONTINUITY

EXT-X-DISCONTINUITY标签表示该标签后边的媒体文件和之前的媒体文件之间的编码间断。特性可能改变的一组是：

file format

number and type of tracks

encoding parameters

encoding sequence

详见第四章，6.2.1、6.3.3。

<pre>

</pre>

### 3.2.9、EXT-X-VERSION

EXT-X-VERSION标签指出了播放列表版本的适应性。播放列表文件、其关联的媒体和服务器必须遵守最新版本的所有规定。

# 四、多媒体文件

每一个媒体文件资源定位符都必须标识一个媒体文件，该文件是整体数据的一个分片。每个媒体文件必须按照MPEG-2的传输流和MPEG-2音频流的格式。[ISO13818]

传输流文件必须包含一个MPEG-2节目。在每个文件的开始应该有一个节目关联表和一个节目映射表。包含视频的文件应该有至少一个关键帧和足够的信息来完全初始化一个视频解码器。

播放列表中的媒体文件必须是编码流中媒体文件的末尾与先前的序列号的延续，除非它是播放列表中出现的第一个媒体文件，或者它前边有EXT-X-DISCONTINUITY标签。

<u>客户端应该准备好处理一个特定类型（音频或视频等）的多个轨道</u>。一个没有优先级的客户端应该选择它能播放的具有最小数字编号的音轨。

客户端应该忽略那些传输流的内部不能识别的流。

媒体文件内样本流和相应的多媒体流的编码参数应保持一致。然而客户端应该解决编码的变化问题，例如缩放视频内容以适应分辨率改变。


# 五、密钥文件

## 5.1 介绍

URL属性中EXT-X-KEY标签标识一个密钥文件。密钥文件包含解密播放列表中媒体文件的密钥。AES-128加密算法使用16字节的密钥。密钥文件的格式为16字节的二进制数数组。

## 5.2 IV FOR AES-128

128位AES在加密和解密的时候需要提供一个相同的16字节的初始化向量（IV），变换IV可以提高密钥的健壮性。

如果EXT-X-KEY标签有IV属性，在使用密钥加密或者解密的时候必须使用此属性值作为IV。这个值必须被解释为128位的16进制数，而且必须有前缀0x。

如果EXT-X-KEY标签没有IV属性，在加密或者解密媒体文件的时候必须使用序列号作为IV值。大端二进制表示的序列号应该放置在16字节的缓冲区中且左边补0。


# 六、客户端/服务器行为

## 6.1介绍

本章介绍服务器怎样产生播放列表和媒体文件以及客户端怎样下载并播放。

## 6.2服务器进程

### 6.2.1介绍

MPEG-2数据流的产生超过了本文档的范围，本文档仅仅假设有一个数据流连续的源（比如rtmp直播流）。

服务器必须将数据流分割成持续时间大致相等的媒体文件，服务器应该尝试点分割流来支持对个别媒体文件的有效解码，例如包和关键帧的边界。

服务器必须为媒体文件创建URL，允许它的客户端能够获取到文件。

服务器必须创建播放列表。播放列表必须符合第三章描述的格式。服务器要提供的媒体文件的URL必须按顺序出现在播放列表中。如果URL出现在了播放列表中，那么这个媒体文件对于客户端必须是可用的。

播放列表文件必须包含一个EXT-X-TARGRTDURATION标签，它必须指明添加到播放列表中媒体文件的最大EXTINF值。整个演示文稿期间，这个值必须保持不变。典型持续时间为10s。

播放列表文件应该（但非必须）包含EXT-X-VERSION标签来说明流对于版本的兼容性。它的值应该是服务器、播放列表文件和其所关联的媒体文件都能执行的最低协议版本。

如果播放列表文件通过HTTP传输，那么<u>服务器应该支持客户端请求使用gzip内容编码</u>。

从客户端的角度来看，播放列表文件的变更必须是自动的。

服务器不可以改变EXT-X-ALLOW-CATCH的值。

播放列表中每个媒体文件的URL必须以EXTINF作为前缀来说明媒体文件的持续时间。

服务器可以将媒体文件和绝对的日期和时间关联起来，只要在它的URL前缀上一个EXT-X-PROGRAM-DATE-TIME标签。 日期和时间的值提供了一个媒体时间表到挂钟时间的信息映射，该挂钟时间可以作为搜索、显示或其他目的的基准。

如果服务器提供了这个映射，那么它应该在每个EXT-X-DISCONTINUITY标签的后边加一个EXT-X-PROGRAM-DATE-TIME标签。

如果播放列表文件包含演示文稿的最后一个分片，那么应该加一个EXT-X-ENDLIST标签。

如果播放列表文件没有包含EXT-X-ENDLIST标签（hls的live流），那么服务器应该使一个新版本的播放列表文件可用，并至少包含一个媒体文件的URL。新的播放列表文件必须与前一个播放列表文件在相对的时间内有效：从上一个播放列表文件开始有效的时间算起，不早于0.5倍持续时间，不晚于1.5倍持续时间。**也就是说hls的live流要时刻更新m3u8文件，而更新时间要保持在[0.5,1.5]个ts持续时间内。**

如果服务器期望移除演示文稿，它必须使播放列表文件对于客户端不可用，<u>在播放列表被清除时，它应该确保播放列表文件中的所有媒体文件对于客户端来说至少在一个播放列表文件持续时间内是可用的</u>。

### 6.2.2滑动窗口播放列表

服务器可以限制最近一段时间添加到播放列表文件中的媒体文件的可用性，为了达到这个目的，播放列表文件必须包含准确的EXT-X-MEDIA-SEQUENCE标签。标签的值是按照从播放列表中移除的媒体文件的URL递增的。

媒体文件的URL必须按照其加入的顺序移除。当服务器从播放列表移除URL时，媒体文件在一段时间内必须保持可用，该时间等于媒体文件的时间加上包含该媒体文件的最长播放列表文件的时间。

当媒体文件通过http传输给客户端后，如果服务器打算移除该文件，那么它应该确保http响应头包含反应生存时间的过期头。

那些不包含EXT-X-ENDLIST标签的播放列表文件的持续时间必须至少三倍于targrt dutration。之所以为三倍的targrt dutration可能是因为，根据hls协议来看，每个终端的播放行为都是不一致的，对于点播的m3u8文件来说，都是从第一个文件开始播，但是对于直播的m3u8，播放器可以从任意一个文件开始向后（新的文件）追溯。不过一般的播放器都是从倒数第三个开始。

### 6.2.3加密媒体文件

如果媒体文件需要被加密，那么服务器必须定义一个URL来允许被授权的客户端获取包含解密密钥的密钥文件。密钥文件必须符合第五章描述的格式。服务器可以在密钥响应中设置超时头来表名密钥可以被缓存。

如果采用AES-128加密算法，那么AES-128 CBC加密模式应该适应于每一个媒体文件。整个文件必须是加密的。密码块的连接不能用于跨媒体文件。用于解密的初始化向量必须是媒体文件的序列号或者EXT-X-KEY标签的IV属性的值。服务器必须使用这种加密算法和其他由紧随在播放列表文件中URL后边的EXT-X-KEY标签所指定的属性来加密播放列表文件中的每一个媒体文件。EXT-X-KEY标签中方法为none或者没有EXT-X-KEY标签的媒体文件不能被加密。

如果播放列表文件包含了一个经过加密的媒体文件的URL，那么服务器不可以将EXT-X-KEY标签从播放列表文件中移除。

### 6.2.4提供变种数据流

服务器可以提供多个播放列表文件来支持对同一个演示文稿的不同编码。**提供变种播放列表文件列出每一个变种流，从而使得客户端可以在不同编码之间动态切换**。

变种播放列表文件必须为每一个变种流包含一个EXT-X-STREAM-INF标签(即嵌套的m3u8结构)。**同一演示文稿的每个EXT-X-STREAM-INF都必须有相同的programid**。**每个演示文稿的programid在变种播放列表内必须是唯一的**。

如果EXT-X-STREAM-INF标签包含CODECS属性，则属性值必须包含RFC4281定义的所有格式，

服务器在生成变种流的时候必须遵守以下规则：

- 1）  每一个变种流必须呈现相同的内容，包括流的间断性。
- 2）  每个变种播放列表文件必须有相同的target duration。
- 3）  只在个别变种播放列表文件中出现的内容必须放在列表文件的头或者尾，且不能超过target duration。
- 4）  变种流内匹配内容，必须有匹配时间戳。这可以使客户端同步流。
- 5）  基本音频流文件必须在文件中第一个样本的采样信号的时间戳前预先准备一个ID3 PRIV标签，标签的所有者标示符为“com.apple.streaming.transportStreamTimestamp”。二进制数据必须是33位的基本时间戳，用8字节的数字表示。

另外，所有的变种流都应该包含相同编码的音频二进制流。这使得客户端在不同的流之间切换时没有毛刺声音（音视频不同步导致的）。

## 6.3客户端进程

### 6.3.1介绍

客户端怎样获取播放列表中的URL不在本文档的范围之内，我们假设已经获取到了URL。

### 6.3.2加载播放列表文件

每一次加载或者重载播放列表文件时：

客户端必须保证播放列表文件以EXTM3U标签开头，并且如果协议版本号存在，客户端必须支持该版本。否则，客户端不可以试图使用该列表文件。

客户端可以忽略它不能识别的标签和属性。

如果播放列表文件包含了EXT-X-MEDIA-SEQUENCE标签，那么客户端会假设在播放列表被加载的时间内以及播放列表的持续时间内媒体文件将变得不可用。播放列表的持续时间等于其中包含的媒体文件时长的总和。

### 6.3.3播放播放列表文件

当开始播放的时候，客户端首先从播放列表中选择要播放的媒体文件。如果不存在EXT-X-ENDLIST标签，并且客户端想正常播放媒体（按顺序以标准速率播放），那么客户端就不应该从播放列表文件尾部选择少于三个target duration的媒体文件。

为了达到正常播放的目的，媒体文件必须按照他们在播放列表中的顺序播放。客户端还可以用其他任何方式播放，比如顺序播放，随机播放，特效播放等。

对于存在EXT-X-DISCONTINUITY标签的媒体文件，在播放之前客户端必须准备好重置分析和解码器。

为了不间断播放，应该提前载入媒体文件，以补偿延时和吞吐量的变化。

如果播放列表文件包含了EXT-X-ALLOW-CATCH标签，并且它的值为NO，那么客户端在播放以后不可以缓存媒体文件。否则允许缓存用来以后重播。

客户端可以使用EXT-X-PROGRAM-DATE-TIME标签来为用户显示节目的起始时间。如果这个值包含了时区信息，那么客户端应该考虑到这点；如果不包含，那么客户端不可以推测时区。

客户端不能依靠EXT-X-ALLOW-CATCH标签值的正确性和一致性。

### 6.3.4重新载入播放列表文件

客户端必须阶段性的重新载入播放列表文件，除非文件包含了EXT-X-ENDLIST标签。然而也不能过于频繁的载入。

当客户端第一次载入播放列表文件或者已经载入但是发现文件与上次载入的时候有了变化，客户端都必须等待一段时间在可以再次载入。这段时间被称为原始最小重载延迟，它是从客户端开始载入一个播放列表文件开始计算的。

**原始最小重载延迟是播放列表文件中最后一个媒体文件的持续时间。媒体文件的持续时间由EXTINF标签来指定。**

**如果客户端重载了一个播放列表文件，但是发现文件并没有变化，那么它在重试之前必须等一段时间。最小延迟是target duration的倍数。第一次是0.5倍，第二次1.5倍，3倍。。。**

### 6.3.5确定下一个要加载的文件

当播放列表文件被载入或者重载以后，客户端必须检查播放列表来确定要载入的媒体文件。要载入的第一个文件必须是客户端要播放的第一个文件（**直播时候，未必是m3u8中的第一个文件**），见6.3.3。

如果要播放的文件已经被载入，并且播放列表文件不包含EXT-X-MEDIA-SEQUENCE标签，那么客户端必须确认播放列表文件包含了最后一个被载入的媒体文件的URL，如果不包含，则暂停播放。要载入的下一个媒体文件必须是上一次载入的媒体文件URL之后的第一个媒体文件的URL。

如果要播放的文件已经被载入，并且播放列表文件包含EXT-X-MEDIA-SEQUENCE标签，那么要载入的下一个媒体文件就是比上一次载入的文件的序列号大的媒体文件中的序列号最小者。

### 6.3.6解密经加密的媒体文件

如果播放列表文件包含了一个指定密钥文件URL的EXT-X-KEY标签，客户端必须获取密钥文件，并使用其中的密钥来解密KEY标签之后的所有媒体文件，直到遇到另一个EXT-X-KEY标签为止。

# 七、协议版本的兼容性

客户端和服务器必须使用版本2以及更高版本。

# 八、例子

## 8.1简单的播放列表文件

```
#EXTM3U
#EXT-X-TARGETDURATION:5220
#EXTINF:5220,

http://media.example.com/entire.ts

#EXT-X-ENDLIST
```

## 8.2滑动窗口播放列表，使用https

```
#EXTM3U

#EXT-X-TARGETDURATION:8

#EXT-X-MEDIA-SEQUENCE:2680

#EXTINF:8,

https://priv.example.com/fileSequence2680.ts

#EXTINF:8,

https://priv.example.com/fileSequence2681.ts

#EXTINF:8,

https://priv.example.com/fileSequence2682.ts
```

## 8.3加密的媒体文件与播放列表文件

```
#EXTM3U

#EXT-X-MEDIA-SEQUENCE:7794

#EXT-X-TARGETDURATION:15

#EXT-X-KEY:METHOD=AES-128,URL="https://priv.example.com/key.php?r=52"

#EXTINF:15,

http://media.example.com/fileSequence52-1.ts

#EXTINF:15,

http://media.example.com/fileSequence52-2.ts

#EXTINF:15,

http://media.example.com/fileSequence52-3.ts

#EXT-X-KEY:METHOD=AES-128,URL="https://priv.example.com/key.php?r=53"

#EXTINF:15,

http://media.example.com/fileSequence53-1.ts

```

## 8.4变种的播放列表文件

```
#EXTM3U

#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1280000

http://example.com/low.m3u8

#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=2560000

http://example.com/mid.m3u8

#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=7680000

http://example.com/hi.m3u8

#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=65000,CODECS="mp4a.40.5"

http://example.com/audio-only.m3u8
```
